name: Deploy Backend to Cloud Run

on:
  push:
    branches: [ main ]
    paths: ['backend_nutri/**']

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Debug - Basic Structure
        run: |
          echo "=== VERIFICANDO ESTRUTURA ==="
          echo "RepositÃ³rio: $(git config --get remote.origin.url)"
          echo "Arquivos em backend_nutri/:"
          ls -la backend_nutri/
          echo "Dockerfile existe: $(test -f backend_nutri/Dockerfile && echo 'âœ…' || echo 'âŒ')"
          echo "requirements.txt existe: $(test -f backend_nutri/requirements.txt && echo 'âœ…' || echo 'âŒ')"
          echo "main.py existe: $(test -f backend_nutri/main.py && echo 'âœ…' || echo 'âŒ')"
      
      - name: Setup Google Cloud Auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          project_id: gama-apps-cloud
      
      - name: Setup GCloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: gama-apps-cloud
      
      - name: Verify Authentication
        run: |
          echo "=== VERIFICANDO AUTENTICAÃ‡ÃƒO ==="
          ACCOUNT=$(gcloud config list account --format="value(core.account)")
          echo "Conta: $ACCOUNT"
          if [ "$ACCOUNT" != "github-actions-deploy@gama-apps-cloud.iam.gserviceaccount.com" ]; then
            echo "âŒ CONTA INCORRETA!"
            exit 1
          fi
          echo "âœ… Conta correta!"
      
      - name: Setup Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
          echo "âœ… Docker configurado"
      
      - name: Build and Push Docker Image
        id: build
        run: |
          cd backend_nutri
          
          echo "=== CONSTRUINDO IMAGEM DOCKER ==="
          IMAGE_URL="us-central1-docker.pkg.dev/gama-apps-cloud/backend-nutri/app:${{ github.sha }}"
          
          # Build da imagem
          docker build -t $IMAGE_URL .
          echo "âœ… Imagem construÃ­da"
          
          # Push para Artifact Registry
          docker push $IMAGE_URL
          echo "âœ… Imagem enviada para: $IMAGE_URL"
          
          echo "image_url=$IMAGE_URL" >> $GITHUB_OUTPUT
      
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          echo "=== IMPLANTANDO NO CLOUD RUN ==="
          IMAGE_URL="${{ steps.build.outputs.image_url }}"
          
          # Deploy no Cloud Run
          gcloud run deploy backend-nutri \
            --image "$IMAGE_URL" \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --timeout 600 \
            --set-env-vars="ACCESS_TOKEN_EXPIRE_MINUTES=30,ALGORITHM=HS256,PYTHONUNBUFFERED=true,SECRET_KEY=@Leeloo10" \
            --quiet
          
          echo "âœ… ImplantaÃ§Ã£o concluÃ­da!"
          
          # Obter URL do serviÃ§o
          SERVICE_URL=$(gcloud run services describe backend-nutri --region us-central1 --format="value(status.url)" --quiet)
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
      
      - name: Show Success Message
        run: |
          echo ""
          echo "ğŸ‰ ğŸ‰ ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO! ğŸ‰ ğŸ‰ ğŸ‰"
          echo ""
          echo "ğŸ“¦ ServiÃ§o: backend-nutri"
          echo "ğŸŒ URL: ${{ steps.deploy.outputs.service_url }}"
          echo "ğŸ³ Imagem: ${{ steps.build.outputs.image_url }}"
          echo "ğŸ“ RegiÃ£o: us-central1"
          echo ""
          echo "ğŸ”— Teste a API: ${{ steps.deploy.outputs.service_url }}/health"
          echo "ğŸ”— Teste as rotas: ${{ steps.deploy.outputs.service_url }}/auth/login"
          echo ""